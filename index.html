<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cotizador Express</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root { --p: #1a73e8; --r: #d93025; --g: #34a853; --o: #ff9800; --l: #f8f9fa; }
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Google Sans', sans-serif; }
    body { background:#f5f5f5; color:#202124; font-size:14px; }
    .container { max-width:480px; margin:0 auto; background:white; border-radius:16px; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
    .header { background:var(--p); color:white; padding:12px; font-size:17px; text-align:center; position:relative; display:flex; align-items:center; justify-content:center; }
    .back-btn { position:absolute; left:12px; font-size:20px; cursor:pointer; }
    .logo { height:36px; margin-right:8px; border-radius:8px; }
    .content { padding:16px; display:none; min-height:calc(100vh - 120px); }
    .content.active { display:block; }
    .db-item { display:flex; align-items:center; gap:12px; padding:14px; background:var(--l); border-radius:12px; margin:8px 0; cursor:pointer; font-size:15px; }
    .db-item svg { width:28px; height:28px; fill:#5f6368; }
    .add-row { display:flex; gap:6px; margin:12px 0; align-items:center; flex-wrap:nowrap; overflow-x:auto; padding-bottom:4px; }
    .add-row input, .add-row select { padding:8px; border:1px solid #dadce0; border-radius:8px; font-size:13px; }
    .add-row input[type="text"] { flex:1; min-width:70px; }
    .add-row input[type="number"] { width:70px; }
    .add-row .btn-add { background:var(--g); color:white; width:36px; height:36px; border-radius:50%; font-weight:bold; font-size:16px; flex-shrink:0; }
    .table { width:100%; border-collapse:collapse; font-size:13px; margin:10px 0; }
    .table th, .table td { border:1px solid #ddd; padding:6px 4px; text-align:center; }
    .table th { background:var(--o); color:white; font-size:12px; }
    .table input { width:100%; padding:4px; border:none; text-align:center; font-size:12px; }
    .btn { padding:8px 12px; border:none; border-radius:8px; font-weight:500; cursor:pointer; margin:4px 2px; font-size:13px; }
    .btn-o { background:var(--o); color:white; }
    .btn-g { background:var(--g); color:white; }
    .btn-b { background:var(--p); color:white; }
    .total { font-weight:bold; text-align:right; padding:10px; background:#e8f0fe; border-radius:8px; margin:12px 0; font-size:15px; }
    .nav-bottom { position:fixed; bottom:0; left:0; right:0; background:white; border-top:1px solid #ddd; display:flex; padding:6px; box-shadow:0 -2px 8px rgba(0,0,0,0.1); z-index:100; }
    .nav-btn { flex:1; text-align:center; padding:10px; color:#5f6368; font-size:11px; cursor:pointer; }
    .nav-btn .active { color:var(--o); font-weight:bold; }
    .select-prod { display:flex; gap:6px; margin:12px 0; padding:8px; background:#f0f0f0; border-radius:8px; align-items:center; }
    .select-prod select { flex:2; }
    .select-prod input { width:60px; }
    .select-prod .stock-info { font-size:12px; color:#5f6368; white-space:nowrap; }
    .select-prod .btn-add { width:36px; height:36px; }
    .form-input { width:100%; padding:10px; margin:6px 0; border:1px solid #ddd; border-radius:8px; }
    .settings { padding:16px; }
    .logo-preview { width:80px; height:80px; border-radius:12px; object-fit:contain; background:#eee; margin:10px 0; }
    .cotiz-item { padding:12px; background:#f0f0f0; border-radius:8px; margin:8px 0; cursor:pointer; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <span class="back-btn" onclick="showSection('db')">Back</span>
    <img id="headerLogo" class="logo" src="" alt="" style="display:none;">
    <span id="pageTitle">Bases</span>
  </div>

  <!-- Bases -->
  <div class="content active" id="dbContent">
    <div class="db-item" onclick="showSection('mano')">
      <svg><use href="#mano"></use></svg>
      <div><strong>Mano de Obra</strong><br><small>Mano de obra calificada.</small></div>
    </div>
    <div class="db-item" onclick="showSection('equipos')">
      <svg><use href="#equipo"></use></svg>
      <div><strong>Equipos</strong><br><small>Equipos y herramientas.</small></div>
    </div>
    <div class="db-item" onclick="showSection('materiales')">
      <svg><use href="#material"></use></svg>
      <div><strong>Materiales</strong><br><small>Materiales de construcción.</small></div>
    </div>
    <div class="db-item" onclick="showSection('ajustes')">
      <svg><use href="#settings"></use></svg>
      <div><strong>Ajustes</strong><br><small>Logo, empresa, etc.</small></div>
    </div>
  </div>

  <!-- Ajustes -->
  <div class="content" id="ajustesContent">
    <h3>Ajustes</h3>
    <div class="settings">
      <label>Nombre de la Empresa:</label>
      <input type="text" id="empresaName" class="form-input" placeholder="Mi Empresa" />
      <label>Logo (200x200):</label>
      <input type="file" id="logoInput" accept="image/*" />
      <img id="logoPreview" class="logo-preview" src="" alt="" style="display:none;" />
      <button class="btn btn-g" onclick="saveSettings()">Guardar</button>
    </div>
  </div>

  <!-- Mano de Obra -->
  <div class="content" id="manoContent">
    <h3>Mano de Obra</h3>
    <div class="add-row">
      <input type="text" id="manoStock" placeholder="N/A" style="width:60px;" />
      <input type="text" id="manoDesc" placeholder="Puesto" style="flex:2;" />
      <input type="number" step="0.01" id="manoLista" placeholder="$PL" style="width:70px;" />
      <input type="number" step="0.01" id="manoPublico" placeholder="$PP" style="width:70px;" />
      <button class="btn-add" onclick="addItem('mano')">+</button>
    </div>
    <table class="table">
      <thead><tr><th>Stock</th><th>Puesto</th><th>$PL</th><th>$PP</th><th></th></tr></thead>
      <tbody id="manoList"></tbody>
    </table>
    <button class="btn btn-o" onclick="saveBase('mano')">Guardar</button>
  </div>

  <!-- Equipos -->
  <div class="content" id="equiposContent">
    <h3>Equipos</h3>
    <div class="add-row">
      <input type="text" id="equipoStock" placeholder="N/A" style="width:60px;" />
      <input type="text" id="equipoDesc" placeholder="Descripción" style="flex:2;" />
      <input type="number" step="0.01" id="equipoLista" placeholder="$PL" style="width:70px;" />
      <input type="number" step="0.01" id="equipoPublico" placeholder="$PP" style="width:70px;" />
      <button class="btn-add" onclick="addItem('equipos')">+</button>
    </div>
    <table class="table">
      <thead><tr><th>Stock</th><th>Descripción</th><th>$PL</th><th>$PP</th><th></th></tr></thead>
      <tbody id="equiposList"></tbody>
    </table>
    <button class="btn btn-o" onclick="saveBase('equipos')">Guardar</button>
  </div>

  <!-- Materiales -->
  <div class="content" id="materialesContent">
    <h3>Materiales</h3>
    <div class="add-row">
      <input type="text" id="matStock" placeholder="Stock" style="width:60px;" />
      <input type="text" id="matMarca" placeholder="Marca" style="flex:1;" />
      <input type="text" id="matDesc" placeholder="Descripción" style="flex:2;" />
      <input type="number" step="0.01" id="matLista" placeholder="$PL" style="width:70px;" />
      <input type="number" step="0.01" id="matPublico" placeholder="$PP" style="width:70px;" />
      <button class="btn-add" onclick="addItem('materiales')">+</button>
    </div>
    <table class="table">
      <thead><tr><th>Stock</th><th>Marca</th><th>Descripción</th><th>$PL</th><th>$PP</th><th></th></tr></thead>
      <tbody id="materialesList"></tbody>
    </table>
    <button class="btn btn-o" onclick="saveBase('materiales')">Guardar</button>
  </div>

  <!-- Cotización -->
  <div class="content" id="cotizContent">
    <div style="background:var(--o); color:white; padding:10px; margin:-16px -16px 16px; border-radius:16px 16px 0 0; font-weight:600;">
      Cotización No: <span id="cotizNum">000001</span>
    </div>
    <div style="display:flex; gap:6px; margin-bottom:12px;">
      <button class="btn btn-o" onclick="abrirListaCotizaciones()">Abrir</button>
      <button class="btn btn-g" onclick="nuevaVenta()">Nueva</button>
    </div>
    <input type="text" id="clienteName" placeholder="Cliente" class="form-input" />
    <input type="text" id="clienteTel" placeholder="Teléfono" class="form-input" />
    <input type="text" id="clienteDir" placeholder="Domicilio" class="form-input" />
    <textarea id="observaciones" placeholder="Observaciones" rows="2" class="form-input"></textarea>

    <div class="select-prod">
      <select id="selectProducto" onchange="updateStockInfo()"><option>Seleccione...</option></select>
      <input type="number" id="cantAdd" placeholder="Cant" min="1" />
      <div class="stock-info" id="stockInfo">Stock: -</div>
      <button class="btn-add" onclick="addToCotizFromSelect()">+</button>
    </div>

    <table class="table">
      <thead><tr><th>Cant</th><th>Producto</th><th>$PP</th><th>Total</th><th></th></tr></thead>
      <tbody id="cotizTable"></tbody>
    </table>
    <div class="total">Total: S/ <span id="cotizTotal">0.00</span></div>
    <div style="display:flex; gap:6px; flex-wrap:wrap;">
      <button class="btn btn-o" onclick="guardarCotizacion()">Guardar</button>
      <button class="btn btn-g" onclick="cobrar()">Cobrar</button>
      <button class="btn btn-b" onclick="imprimirPDF()">Guardar PDF</button>
      <button class="btn btn-g" onclick="enviarCotizacion()">Enviar</button>
    </div>
  </div>

  <!-- Lista de Cotizaciones -->
  <div class="content" id="listaCotizContent">
    <h3>Cotizaciones Guardadas</h3>
    <div id="listaCotiz"></div>
    <button class="btn btn-g" onclick="showSection('cotiz')">Volver</button>
  </div>
</div>

<div class="nav-bottom">
  <div class="nav-btn active" onclick="showSection('db')">Bases</div>
  <div class="nav-btn" onclick="showSection('cotiz')">$ Cotización</div>
</div>

<svg style="display:none;">
  <symbol id="mano" viewBox="0 0 24 24"><path d="M12 6v4h-1V6h1zm-1 6v6h1v-6h-1zm2-6h1v4h-1V6zm-2 6h1v6h-1v-6zm2 0h1v6h-1v-6z"/></symbol>
  <symbol id="equipo" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></symbol>
  <symbol id="material" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></symbol>
  <symbol id="settings" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.33-.02-.64-.06-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22l-1.92 3.32c-.15.25-.08.56.12.61l2.03 1.58c-.04.3-.06.61-.06.94 0 .33.02.64.06.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.15.25.37.31.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .43-.17.47-.41l-.36-2.54c-.59-.24-1.13-.57-1.62-.94l2.39.96c.22.09.44.03.59-.22l1.92-3.32c.15-.25.08-.56-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></symbol>
</svg>

<script>
  let db = { config: { empresa: 'Mi Empresa', logo: '' }, mano: [], equipos: [], materiales: [], cotizaciones: [], cActual: null };

  document.addEventListener('DOMContentLoaded', () => {
    loadDB();
    nuevaVenta();
    showSection('db');
    updateProductoSelect();
    loadLogo();
  });

  function loadDB() {
    try {
      const saved = localStorage.getItem('cotizador_db');
      if (saved) db = JSON.parse(saved);
      else {
        db.materiales = [
          { id: 1, stock: "20", marca: "Moctezuma", desc: "Cemento", precioLista: 120, precioPublico: 145 },
          { id: 2, stock: "30", marca: "Sika", desc: "Aditivo", precioLista: 45, precioPublico: 58 }
        ];
      }
    } catch (e) { console.error('Error loading DB:', e); }
    renderAllBases();
  }

  function saveDB() { 
    try { 
      localStorage.setItem('cotizador_db', JSON.stringify(db));
    } catch (e) { 
      alert("Error al guardar. Libera espacio."); 
    }
  }

  function showSection(sec) {
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    const el = document.getElementById(sec + 'Content');
    if (el) el.classList.add('active');
    document.getElementById('pageTitle').textContent = { db: 'Bases', ajustes: 'Ajustes', mano: 'Mano de Obra', equipos: 'Equipos', materiales: 'Materiales', cotiz: 'Cotización', listaCotiz: 'Cotizaciones' }[sec] || 'App';
    if (sec !== 'db' && sec !== 'ajustes') renderBase(sec);
    if (sec === 'cotiz') { renderCotizTable(); updateProductoSelect(); updateStockInfo(); }
    if (sec === 'listaCotiz') renderListaCotizaciones();
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.nav-btn')[sec === 'db' ? 0 : 1].classList.add('active');
  }

  // === LOGO ===
  document.getElementById('logoInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      db.config.logo = ev.target.result;
      document.getElementById('logoPreview').src = db.config.logo;
      document.getElementById('logoPreview').style.display = 'block';
      loadLogo();
      saveDB();
    };
    reader.readAsDataURL(file);
  });

  function loadLogo() {
    if (db.config.logo) {
      document.getElementById('headerLogo').src = db.config.logo;
      document.getElementById('headerLogo').style.display = 'block';
    }
  }

  function saveSettings() {
    db.config.empresa = document.getElementById('empresaName').value.trim() || 'Mi Empresa';
    saveDB();
    loadLogo();
    alert('Guardado');
  }

  // === BASES ===
  function addItem(type) {
    const prefix = type === 'mano' ? 'mano' : type === 'equipos' ? 'equipo' : 'mat';
    const stockInput = document.getElementById(prefix + 'Stock');
    const stock = (type === 'mano'|| type === 'equipos') ? (stockInput.value.trim() || 'N/A') : (stockInput.value.trim() || '0');
    const desc = document.getElementById(prefix + (type === 'materiales' ? 'Marca' : 'Desc')).value.trim();
    const desc2 = type === 'materiales' ? document.getElementById('matDesc').value.trim() : '';
    const lista = parseFloat(document.getElementById(prefix + 'Lista').value) || 0;
    const publico = parseFloat(document.getElementById(prefix + 'Publico').value) || 0;

    if (!desc || lista <= 0 || publico <= 0) return alert('Complete todos los campos');

    const nuevo = { id: Date.now(), stock: stock === 'N/A' ? 'N/A' : parseInt(stock), precioLista: lista, precioPublico: publico };
    if (type === 'mano') nuevo.puesto = desc;
    else if (type === 'equipos') nuevo.desc = desc;
    else { nuevo.marca = desc; nuevo.desc = desc2; }

    db[type].push(nuevo);
    clearAddRow(type);
    renderBase(type);
    updateProductoSelect();
    saveDB();
  }

  function deleteItem(type, id) {
    db[type] = db[type].filter(x => x.id !== id);
    renderBase(type);
    updateProductoSelect();
    saveDB();
  }

  function renderBase(type) {
    const list = document.getElementById(type + 'List');
    if (!list) return;
    list.innerHTML = '';
    db[type].forEach(x => {
      const tr = document.createElement('tr');
      let cols = type === 'mano' 
        ? [x.stock, x.puesto, x.precioLista.toFixed(2), x.precioPublico.toFixed(2)]
        : type === 'equipos'
        ? [x.stock, x.desc, x.precioLista.toFixed(2), x.precioPublico.toFixed(2)]
        : [x.stock, x.marca, x.desc, x.precioLista.toFixed(2), x.precioPublico.toFixed(2)];
      tr.innerHTML = cols.map(c => `<td>${c}</td>`).join('') + `<td><button class="btn" style="background:var(--r);color:white;padding:4px 6px;" onclick="deleteItem('${type}',${x.id})">X</button></td>`;
      list.appendChild(tr);
    });
  }

  function renderAllBases() { ['mano', 'equipos', 'materiales'].forEach(renderBase); }

  function clearAddRow(type) {
    const prefix = type === 'mano' ? 'mano' : type === 'equipos' ? 'equipo' : 'mat';
    ['Stock', (type === 'materiales' ? 'Marca' : 'Desc'), 'Lista', 'Publico'].forEach(s => {
      const el = document.getElementById(prefix + s);
      if (el) el.value = '';
    });
    if (type === 'materiales') document.getElementById('matDesc').value = '';
  }

  function saveBase(type) { saveDB(); alert('Guardado'); }

  // === COTIZACIÓN ===
  function nuevaVenta() {
    db.cActual = { id: Date.now(), num: pad(db.cotizaciones.length + 1), cliente: '', tel: '', dir: '', obs: '', items: [], estado: 'Borrador' };
    cargarCotizActual();
    showSection('cotiz');
  }

  function cargarCotizActual() {
    const c = db.cActual;
    if (!c) return;
    document.getElementById('cotizNum').textContent = c.num;
    document.getElementById('clienteName').value = c.cliente || '';
    document.getElementById('clienteTel').value = c.tel || '';
    document.getElementById('clienteDir').value = c.dir || '';
    document.getElementById('observaciones').value = c.obs || '';
    renderCotizTable();
  }

  function updateProductoSelect() {
    const select = document.getElementById('selectProducto');
    if (!select) return;
    select.innerHTML = '<option>Seleccione...</option>';
    ['mano', 'equipos', 'materiales'].forEach(type => {
      db[type].forEach(item => {
        const text = type === 'mano' ? item.puesto : type === 'equipos' ? item.desc : `${item.marca} - ${item.desc}`;
        const opt = new Option(text, `${type}-${item.id}`);
        if (item.stock !== 'N/A' && item.stock <= 0) opt.disabled = true;
        select.add(opt);
      });
    });
    updateStockInfo();
  }

  function updateStockInfo() {
    const select = document.getElementById('selectProducto');
    const info = document.getElementById('stockInfo');
    if (!select.value) {
      info.textContent = 'Stock: -';
      return;
    }
    const [type, idStr] = select.value.split('-');
    const id = parseInt(idStr);
    const item = db[type].find(x => x.id === id);
    if (!item || item.stock === 'N/A') {
      info.textContent = 'Stock: ∞';
    } else {
      const usado = getStockUsado(type, id);
      const disponible = item.stock - usado;
      info.textContent = `Stock: ${disponible}`;
      info.style.color = disponible <= 0 ? 'red' : '#5f6368';
    }
  }

  function getStockUsado(type, id) {
    let usado = 0;
    db.cotizaciones.forEach(c => {
      if (c.estado === 'Pagado') {
        c.items.forEach(i => {
          if (i.type === type && i.matId === id) usado += i.cant;
        });
      }
    });
    return usado;
  }

  function addToCotizFromSelect() {
    const select = document.getElementById('selectProducto');
    const cantInput = document.getElementById('cantAdd');
    const cant = parseInt(cantInput.value) || 0;
    if (!select.value || cant <= 0) return alert('Seleccione producto y cantidad');
    if (!db.cActual) nuevaVenta();

    const [type, idStr] = select.value.split('-');
    const id = parseInt(idStr);
    const item = db[type].find(x => x.id === id);
    if (!item) return;

    if (item.stock !== 'N/A') {
      const usado = getStockUsado(type, id);
      const disponible = item.stock - usado;
      if (cant > disponible) return alert(`Solo hay ${disponible} disponibles`);
    }

    const existe = db.cActual.items.find(x => x.type === type && x.matId === id);
    if (existe) {
      const nuevoTotal = existe.cant + cant;
      if (item.stock !== 'N/A') {
        const usado = getStockUsado(type, id);
        const disponible = item.stock - usado;
        if (nuevoTotal > disponible) return alert(`Máximo ${disponible} disponibles`);
      }
      existe.cant = nuevoTotal;
    } else {
      db.cActual.items.push({ type, matId: id, cant });
    }

    cantInput.value = '';
    select.value = '';
    updateStockInfo();
    renderCotizTable();
  }

  function renderCotizTable() {
    const tbody = document.getElementById('cotizTable');
    if (!tbody || !db.cActual?.items?.length) {
      tbody.innerHTML = '<tr><td colspan="5" style="color:#999;">Seleccione arriba</td></tr>';
      document.getElementById('cotizTotal').textContent = '0.00';
      return;
    }

    let total = 0;
    tbody.innerHTML = '';
    db.cActual.items.forEach((item, i) => {
      const base = db[item.type].find(x => x.id === item.matId);
      if (!base) return;
      const desc = item.type === 'mano' ? base.puesto : item.type === 'equipos' ? base.desc : `${base.marca}<br><small>${base.desc}</small>`;
      const pt = item.cant * base.precioPublico;
      total += pt;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="number" value="${item.cant}" onchange="updateItem(${i},this.value)" style="width:50px;" /></td>
        <td>${desc}</td>
        <td>S/ ${base.precioPublico.toFixed(2)}</td>
        <td>S/ ${pt.toFixed(2)}</td>
        <td><button class="btn" style="background:var(--r);color:white;padding:4px 6px;" onclick="removeItem(${i})">X</button></td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('cotizTotal').textContent = total.toFixed(2);
  }

  function updateItem(i, cantStr) {
    const cant = parseInt(cantStr) || 0;
    if (cant <= 0) { removeItem(i); return; }
    const item = db.cActual.items[i];
    const base = db[item.type].find(x => x.id === item.matId);
    if (base && base.stock !== 'N/A') {
      const usado = getStockUsado(item.type, item.matId);
      const disponible = base.stock - usado;
      if (cant > disponible) {
        alert(`Máximo ${disponible} disponibles`);
        renderCotizTable();
        return;
      }
    }
    item.cant = cant;
    renderCotizTable();
  }

  function removeItem(i) { 
    db.cActual.items.splice(i, 1); 
    renderCotizTable(); 
    updateStockInfo();
  }

  function guardarCotizacion() {
    const c = db.cActual;
    if (!c || !c.items.length) return alert('Agrega productos');
    c.cliente = document.getElementById('clienteName').value;
    c.tel = document.getElementById('clienteTel').value;
    c.dir = document.getElementById('clienteDir').value;
    c.obs = document.getElementById('observaciones').value;
    const index = db.cotizaciones.findIndex(x => x.id === c.id);
    if (index >= 0) db.cotizaciones[index] = c; else db.cotizaciones.push(c);
    saveDB();
    alert('Guardado con éxito');
  }

  function cobrar() {
    const total = parseFloat(document.getElementById('cotizTotal').textContent) || 0;
    const popup = document.createElement('div');
    popup.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
    popup.innerHTML = `<div style="background:white;padding:20px;border-radius:16px;width:90%;max-width:400px;">
      <h3>Total: S/ ${total.toFixed(2)}</h3>
      <input type="number" step="0.01" id="recibido" placeholder="Recibido" style="width:100%;padding:10px;margin:10px 0;border:1px solid #ddd;border-radius:8px;" />
      <div style="display:flex;gap:8px;">
        <button class="btn" style="background:#eee;" onclick="this.closest('div').parentElement.remove()">Cancelar</button>
        <button class="btn btn-g" onclick="procesarPago(${total})">Aceptar</button>
      </div>
    </div>`;
    document.body.appendChild(popup);
  }

  function procesarPago(total) {
    const recibido = parseFloat(document.getElementById('recibido').value) || 0;
    const cambio = recibido - total;
    db.cActual.estado = recibido >= total ? 'Pagado' : 'Pendiente';
    guardarCotizacion();
    if (recibido >= total) restarStock();
    alert(cambio >= 0 ? `¡PAGO COMPLETADO!\nCambio: S/ ${cambio.toFixed(2)}` : `Faltan: S/ ${(-cambio).toFixed(2)}`);
    imprimirPDF();
    document.querySelector('div[style*="z-index:1000"]')?.remove();
  }

  function restarStock() {
    db.cActual.items.forEach(i => {
      const base = db[i.type].find(x => x.id === i.matId);
      if (base && base.stock !== 'N/A') {
        base.stock -= i.cant;
        if (base.stock < 0) base.stock = 0;
      }
    });
    saveDB();
    renderAllBases();
    updateProductoSelect();
  }

  async function imprimirPDF() {
    const c = db.cActual;
    const total = parseFloat(document.getElementById('cotizTotal').textContent) || 0;
    const empresa = db.config.empresa || 'Mi Empresa';

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    if (db.config.logo) doc.addImage(db.config.logo, 'PNG', 15, 10, 30, 30);
    doc.setFontSize(16); doc.text(empresa, 50, 25);
    doc.setFontSize(10); doc.text(`Cot: ${c.num} | ${new Date().toLocaleDateString()} | ${c.estado}`, 15, 45);
    doc.setFontSize(11); doc.text(`Cliente: ${c.cliente} | ${c.tel} | ${c.dir}`, 15, 55);

    const data = c.items.map(i => {
      const b = db[i.type].find(x => x.id === i.matId);
      return [i.cant, i.type === 'mano' ? b.puesto : i.type === 'equipos' ? b.desc : `${b.marca} - ${b.desc}`, `S/ ${b.precioPublico.toFixed(2)}`, `S/ ${(i.cant*b.precioPublico).toFixed(2)}`];
    });
    doc.autoTable({ head: [['Cant', 'Producto', '$PP', 'Total']], body: data, startY: 65 });
    doc.text(`Total: S/ ${total.toFixed(2)}`, 160, doc.lastAutoTable.finalY + 15);
    doc.text(`Obs: ${c.obs}`, 15, doc.lastAutoTable.finalY + 25);

    const blob = doc.output('blob');
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Cotizacion_${c.num}.pdf`;
    a.click();
    URL.revokeObjectURL(url);
  }

  async function enviarCotizacion() {
    await imprimirPDF();
    alert("PDF generado en Descargas. Envíe por WhatsApp");
  }

  function abrirListaCotizaciones() {
    showSection('listaCotiz');
  }

  function renderListaCotizaciones() {
    const container = document.getElementById('listaCotiz');
    container.innerHTML = '';
    if (!db.cotizaciones.length) {
      container.innerHTML = '<p style="color:#999;">No hay cotizaciones guardadas</p>';
      return;
    }
    db.cotizaciones.forEach(c => {
      const total = c.items.reduce((sum, i) => {
        const b = db[i.type].find(x => x.id === i.matId);
        return sum + (i.cant * (b?.precioPublico || 0));
      }, 0);
      const div = document.createElement('div');
      div.className = 'cotiz-item';
      div.innerHTML = `<strong>Cot: ${c.num}</strong> | ${c.cliente || 'Sin cliente'} | S/ ${total.toFixed(2)} | ${c.estado}<br><small>${new Date(c.id).toLocaleDateString()}</small>`;
      div.onclick = () => {
        db.cActual = JSON.parse(JSON.stringify(c));
        cargarCotizActual();
        showSection('cotiz');
      };
      container.appendChild(div);
    });
  }

  function pad(n) { return String(n).padStart(6, '0'); }
</script>
</body>
  </html>
